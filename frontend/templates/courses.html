{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="text-center mb-5">
        <h2 class="fw-bold text-primary">Courses & Branches</h2>
        <p class="text-muted">Explore the various courses and branches offered under COMEDK.</p>
    </div>

    <div class="row justify-content-center mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                <input type="text" class="form-control border-start-0 ps-0" id="courseSearch" placeholder="Search by Course Name or Code...">
            </div>
        </div>
    </div>

    <ul class="nav nav-pills nav-fill mb-4 justify-content-center gap-2" id="courseTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active bg-dark text-white" id="general-tab" data-bs-toggle="pill" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">General Courses</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link bg-secondary text-white" id="engineering-tab" data-bs-toggle="pill" data-bs-target="#engineering" type="button" role="tab" aria-controls="engineering" aria-selected="false">Engineering Branches</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link bg-secondary text-white" id="architecture-tab" data-bs-toggle="pill" data-bs-target="#architecture" type="button" role="tab" aria-controls="architecture" aria-selected="false">Architecture Branches</button>
        </li>
    </ul>

    <style>
        .nav-pills .nav-link.active {
            background-color: #212529 !important; /* Dark */
            border: 2px solid #0d6efd;
        }
        .nav-pills .nav-link:not(.active) {
            background-color: #6c757d !important; /* Secondary */
            color: white !important;
        }
        @keyframes pop-highlight {
            0% { transform: scale(1); box-shadow: none; background-color: transparent; }
            20% { transform: scale(1.02); box-shadow: 0 0 20px rgba(13, 110, 253, 0.6); background-color: rgba(13, 110, 253, 0.2); z-index: 10; position: relative; border-radius: 5px; }
            80% { transform: scale(1.02); box-shadow: 0 0 20px rgba(13, 110, 253, 0.6); background-color: rgba(13, 110, 253, 0.2); z-index: 10; position: relative; border-radius: 5px; }
            100% { transform: scale(1); box-shadow: none; background-color: transparent; }
        }
        .highlight-row {
            animation: pop-highlight 2s ease-in-out;
        }
        .highlight-row td {
            transition: background-color 0.3s;
        }
    </style>

    <div class="tab-content" id="courseTabsContent">
        <!-- No results message -->
        <div id="noResultsMessage" class="alert alert-warning text-center mt-3" style="display:none;">No results found.</div>
        <!-- General Courses -->
        <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <h5 class="card-title text-primary mb-4">Undergraduate Courses</h5>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center p-3 border rounded bg-dark text-white">
                                        <i class="fas fa-user-md fa-2x text-success me-3"></i>
                                        <div>
                                            <h6 class="mb-0 fw-bold">M.B.B.S</h6>
                                            <small class="text-white-50">Medical</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center p-3 border rounded bg-dark text-white">
                                        <i class="fas fa-tooth fa-2x text-info me-3"></i>
                                        <div>
                                            <h6 class="mb-0 fw-bold">B.D.S</h6>
                                            <small class="text-white-50">Dental</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center p-3 border rounded bg-dark text-white" onclick="document.getElementById('engineering-tab').click()" style="cursor: pointer;">
                                        <i class="fas fa-cogs fa-2x text-primary me-3"></i>
                                        <div>
                                            <h6 class="mb-0 fw-bold">B.E</h6>
                                            <small class="text-white-50">Bachelor of Engineering</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center p-3 border rounded bg-dark text-white" onclick="document.getElementById('architecture-tab').click()" style="cursor: pointer;">
                                        <i class="fas fa-drafting-compass fa-2x text-warning me-3"></i>
                                        <div>
                                            <h6 class="mb-0 fw-bold">B.Arch</h6>
                                            <small class="text-white-50">Bachelor of Architecture</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Engineering Branches -->
        <div class="tab-pane fade" id="engineering" role="tabpanel" aria-labelledby="engineering-tab">
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 table-striped table-dark">
                            <thead class="text-white">
                                <tr>
                                    <th class="py-3 px-4" style="width: 10%;">Sl No.</th>
                                    <th class="py-3 px-4">Branch Name</th>
                                    <th class="py-3 px-4" style="width: 15%;">Branch Code</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for branch in engineering_branches %}
                                <tr id="code-{{ branch.code|upper }}">
                                    <td class="py-2 px-4">{{ branch.sl_no }}</td>
                                    <td class="py-2 px-4 fw-medium">{{ branch.name }}</td>
                                    <td class="py-2 px-4"><span class="badge bg-secondary">{{ branch.code }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="mt-3 text-muted small">
                <p>(*) Branches have shift courses</p>
            </div>
        </div>

        <!-- Architecture Branches -->
        <div class="tab-pane fade" id="architecture" role="tabpanel" aria-labelledby="architecture-tab">
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 table-striped table-dark">
                            <thead class="text-white">
                                <tr>
                                    <th class="py-3 px-4" style="width: 10%;">Sl No.</th>
                                    <th class="py-3 px-4">Branch Name</th>
                                    <th class="py-3 px-4" style="width: 15%;">Branch Code</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for branch in architecture_branches %}
                                <tr id="code-{{ branch.code|upper }}">
                                    <td class="py-2 px-4">{{ branch.sl_no }}</td>
                                    <td class="py-2 px-4 fw-medium">{{ branch.name }}</td>
                                    <td class="py-2 px-4"><span class="badge bg-secondary">{{ branch.code }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle URL parameters for highlighting
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        
        if (code) {
            const rowId = 'code-' + code;
            const row = document.getElementById(rowId);
            
            if (row) {
                // Find which tab this row belongs to
                const tabPane = row.closest('.tab-pane');
                if (tabPane) {
                    const tabId = tabPane.id;
                    const tabTrigger = document.querySelector(`[data-bs-target="#${tabId}"]`);
                    
                    if (tabTrigger) {
                        // Activate the tab
                        const tab = new bootstrap.Tab(tabTrigger);
                        tab.show();
                        
                        // Wait for tab transition, then scroll and highlight
                        setTimeout(() => {
                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            row.classList.add('highlight-row');
                        }, 200);
                    }
                }
            }
        }

        const searchInput = document.getElementById('courseSearch');
        
        // Handle URL Parameters for auto-search/highlight
        const urlParams = new URLSearchParams(window.location.search);
        const codeParam = urlParams.get('code');
        
        if (codeParam) {
            searchInput.value = codeParam;
            // Trigger search immediately
            const event = new Event('keyup');
            searchInput.dispatchEvent(event);
            
            // Wait for search to apply then switch tabs if needed
            setTimeout(() => {
                // Check where the code was found
                // If finding by code, it's likely in tables (Engineering/Architecture)
                const tables = document.querySelectorAll('.table');
                let found = false;
                
                tables.forEach(table => {
                    if (found) return;
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                         if (found) return;
                         const code = row.cells[2].textContent.toLowerCase(); // Code is 3rd column (index 2)
                         if (code.includes(codeParam.toLowerCase())) {
                             // Switch to this tab
                             const tabPane = table.closest('.tab-pane');
                             if (tabPane) {
                                  const tabId = tabPane.id;
                                  const tabButton = document.querySelector(`button[data-bs-target="#${tabId}"]`);
                                  if (tabButton) tabButton.click();
                             }
                             // Highlight
                             row.classList.add('highlight-row');
                             row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                             found = true;
                         }
                    });
                });
            }, 300);
        }

        searchInput.addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase();
            // Find the currently active tab
            const activeTabPane = document.querySelector('.tab-pane.active.show');
            if (!activeTabPane) return;

            let anyVisible = false;

            // If General tab is active, filter cards
            if (activeTabPane.id === 'general') {
                const cards = activeTabPane.querySelectorAll('.col-md-6');
                cards.forEach(card => {
                    const h6 = card.querySelector('h6');
                    const small = card.querySelector('small');
                    const title = h6 ? h6.textContent.toLowerCase() : '';
                    const subtitle = small ? small.textContent.toLowerCase() : '';
                    if (title.includes(searchTerm) || subtitle.includes(searchTerm)) {
                        card.style.display = '';
                        anyVisible = true;
                    } else {
                        card.style.display = 'none';
                    }
                });
            } else {
                // For Engineering or Architecture tabs, filter table rows
                const table = activeTabPane.querySelector('table');
                if (!table) return;
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const name = row.cells[1].textContent.toLowerCase();
                    const code = row.cells[2].textContent.toLowerCase();
                    if (name.includes(searchTerm) || code.includes(searchTerm)) {
                        row.style.display = '';
                        anyVisible = true;
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            // Show/hide 'No results found' message
            const noResultsMsg = document.getElementById('noResultsMessage');
            if (searchTerm && !anyVisible) {
                noResultsMsg.style.display = '';
            } else {
                noResultsMsg.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}
